# 1Shot Telegram Bot Demo

This is a simple Telegram bot (built with [python-telegram-bot](https://python-telegram-bot.org/)) and 
[FastAPI](https://fastapi.tiangolo.com/) that shows how to implement a conversation flow and webhook handling.

Interactions with [1Shot API](https://1shotapi.com) are done with the [1Shot Python SDK](https://pypi.org/project/uxly-1shot-client/). 

## 1. Register a Telegram Bot

Start by using the [@BotFather](https://telegram.me/BotFather) Telegram bot to register your own Telegram bot and get a Telegram API Token. 

Enter the bot's token in the [`docker-compose.env`](/docker-compose.env#L3) file for `TELEGRAM_BOT_TOKEN`.

## 2. Create a 1Shot API Account

Log into 1Shot and create a new API key and secret from the [API Keys](https://app.1shotapi.com/api-keys) page. You'll need both the API key and secret for your bot. 

Also, go to the [Organizations page](https://app.1shotapi.com/organizations) and click on the "Details" button of the organization your are working in; grab its business ID. 

Enter these three credentials into [`docker-compose.env`](/docker-compose.env#L6) in the `ONESHOT_API_KEY`, `ONESHOT_API_SECRET`, and `ONESHOT_BUSINESS_ID` variables. 

## 3. Ngrok for Catching Webhooks

This example repo is set up with the [Ngrok](https://ngrok.io) tunneling service in order to receive webhook callbacks from both Telegram and 1Shot API when developing from your local machine. Make a free account and go to the "Endpoints" tab. 

Generate a static endpoint URL that will be used between restarts of you bot. Enter the URL generated by Ngrok into [`docker-compose.yaml`](/docker-compose.yaml#L10) file. 

Next, get your Ngrok auth token from the "Your Authtoken" tab. Enter the Ngrok auth token into the [`docker-compose.env`](/docker-compose.env#L4) for the `NGROK_AUTHTOKEN` variable.

## 3. Build the Bot's Docker Image

Clone this repo and build the Telegram service container image:

```sh
docker compose build telegram-service
```

## 4. Run the Bot Stack

After you have set the Telegram bot token, API key and secret, business id, and Ngrok auth token and endpoint url, run the bot stack: 

```sh
docker compose --env-file docker-compose.env up -d
```

The `docker-compose.yaml` file is setup to mount the `src` directory into the `/bot` directory of the Telegram bot's container. You can
make edits to the source code while the bot is running and then reload the bot quickly like this:

```sh
docker compose restart telegram-service
```

> [!NOTE] 
> The If you add new environment variables or change the docker configuration you'll need to run `docker compose down` then rerun `docker compose --env-file docker-compose.env up -d`

## 5. Stream Logs While You Develop

You can check what's happening in your bot while it is running by streaming the logs from the telegram container:

```sh
docker logs -f telegram
```

# Ideas for Creating Production Bots

[Firestore](https://firebase.google.com/docs/firestore) and [Cloudflare D1](https://developers.cloudflare.com/d1/) are great options for 
database technologies for running production Telegram bot applications with non-trivial amounts of users. They also have generous free usage
teirs. 

While this starter repo is setup with Ngrok tunneling so that Telegram and 1Shot API can reach your bot for webhooks when running from 
your laptop, [Cloud Run](https://cloud.google.com/run), [Digital Ocean Droplets](https://www.digitalocean.com/products/droplets), 
and [Cloud Workers](https://developers.cloudflare.com/workers/languages/python/packages/fastapi/) are also great options for hosting that 
also have good free tiers. 